{% extends "sistema_2/layout_3.html" %}

{% load static %}


{% block code %}
<link href="https://cdn.datatables.net/1.12.1/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.12.1/js/dataTables.bootstrap5.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta2/dist/js/bootstrap-select.min.js"></script>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta2/dist/css/bootstrap-select.min.css">

<script>
    addEventListener('DOMContentLoaded',()=>{
        let clienteSeleccionado = document.getElementById('clienteSeleccionado')
        let facturaSeleccionada = document.getElementById('facturaSeleccionada')
        let guiaSeleccionada = document.getElementById('guiaSeleccionada')
        let cotiSeleccionada= document.getElementById('cotiSeleccionada')

        clienteSeleccionado.onchange = function() 
        {
            url = '/sistema_2/obtener_facturas_cotizaciones_cliente/' + clienteSeleccionado.value
            async function get_data() {
                const res = await fetch(url,{
                                        method:"GET",
                                        headers: {
                                            "X-Requested-With": "XMLHttpRequest",
                                        },})
                cliente_info=await res.json()
                console.log(cliente_info)
                facturaSeleccionada.innerHTML = ''
                cotiSeleccionada.innerHTML = ''
                if(cliente_info.tipoCliente === 'Empresa')
                {
                    var opcionCreada = document.createElement('option')
                    opcionCreada.value = 'SinSeleccion'
                    opcionCreada.text = 'SinSeleccion'
                    facturaSeleccionada.add(opcionCreada)
                    for(var i = 0; i < cliente_info.facturas.length; i++)
                    {
                        console.log('Se ingreso al bucle')
                        var opcionCreada = document.createElement('option')
                        opcionCreada.value = cliente_info.facturas[i]
                        opcionCreada.text = cliente_info.facturas[i]
                        facturaSeleccionada.add(opcionCreada)
                    }
                    

                    var opcionCreada = document.createElement('option')
                    opcionCreada.value = 'SinSeleccion'
                    opcionCreada.text = 'SinSeleccion'
                    cotiSeleccionada.add(opcionCreada)
                    for(var i = 0; i < cliente_info.cotizaciones.length; i++)
                    {
                        console.log('Se ingreso al bucle')
                        var opcionCreada = document.createElement('option')
                        opcionCreada.value = cliente_info.cotizaciones[i]
                        opcionCreada.text = cliente_info.cotizaciones[i]
                        cotiSeleccionada.add(opcionCreada)
                    }
                    
                }
                if(cliente_info.tipoCliente === 'Persona')
                {
                    var opcionCreada = document.createElement('option')
                    opcionCreada.value = 'SinSeleccion'
                    opcionCreada.text = 'SinSeleccion'
                    facturaSeleccionada.add(opcionCreada)
                    for(var i = 0; i < cliente_info.boletas.length; i++)
                    {
                        var opcionCreada = document.createElement('option')
                        opcionCreada.value = cliente_info.boletas[i]
                        opcionCreada.text = cliente_info.boletas[i]
                        facturaSeleccionada.add(opcionCreada)
                    }
                    
                    var opcionCreada = document.createElement('option')
                    opcionCreada.value = 'SinSeleccion'
                    opcionCreada.text = 'SinSeleccion'
                    cotiSeleccionada.add(opcionCreada)
                    for(var i = 0; i < cliente_info.cotizaciones.length; i++)
                    {
                        console.log('Se ingreso al bucle')
                        var opcionCreada = document.createElement('option')
                        opcionCreada.value = cliente_info.cotizaciones[i]
                        opcionCreada.text = cliente_info.cotizaciones[i]
                        cotiSeleccionada.add(opcionCreada)
                    }
                }
            }
            get_data()
        }

        facturaSeleccionada.onchange = function()
        {
            url = '/sistema_2/obtener_guias_factura/' + facturaSeleccionada.value
            async function get_data() {
                const res = await fetch(url,{
                                        method:"GET",
                                        headers: {
                                            "X-Requested-With": "XMLHttpRequest",
                                        },})
                cliente_info=await res.json()
                console.log(cliente_info)
                guiaSeleccionada.value = ''
                guiaSeleccionada.value = cliente_info.guias
            }
            get_data()
        }



    })
</script>


{% endblock %}


{% block content %}

<h5 class="modal-title">Actualizar registro</h5>
<form method="post" action="{% url 'sistema_2:actualizar_mov' operacion.id %}">
{% csrf_token %}
    </div>
        <div class="modal-body">
        <h6>Campos obligatorios (*)</h6>
        <br>
    <div class="row mb-3">
        <div class="col-md-3">
            <label>Concepto</label>
            <input type="text" class="form-control" name="nombre" id="actNombre" value="{{ operacion.detalleOperacion }}">
        </div>
        <div class="col-md-6">
            <label>Cliente</label>
            <select class="selectpicker form-control" name="infoCliente" id="clienteSeleccionado">
                {% for cliente in clientes %}
                    {% if cliente.nombre != '' %}
                        <option value="{{ cliente.id }}">{{ cliente.nombre }} {{ cliente.apellido }}</option>
                    {% else %}
                        <option value="{{ cliente.id }}">{{ cliente.razon_social }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-md-4">
            <label>Moneda</label>
            <input type="text" class="form-control" name="categoria" id="actCategoria" value="{{ operacion.monedaOperacion }}">
        </div>
        <div class="col-md-3">
            <label>Monto</label>
            <input type="text" class="form-control" name="subCategoria" id="actSubCategoria" value="{{ operacion.montoOperacion }}">
        </div>
        <div class="col-md-3">
            <label>Nro de operacion</label>
            <input type="text" class="form-control" name="subCategoria" id="actSubCategoria" value="{{ operacion.nroOperacion }}">
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-md-4">
            <label>CÃ³digo del vendedor</label>
            <select class="selectpicker form-control" name="infoVendedor">
                {% for usuario in usuarios %}
                    <option value="{{ usuario.id }}">{{ usuario.codigo }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    <br>
    <h6>Documentos asociados</h6>
    <br>
    <div class="row mb-3">
        <div class="col-md-3">
            <label>Cotizacion</label>
            <select class="form-select" name="infoCotizacion" id="cotiSeleccionada" >
            </select>
        </div>
        <div class="col-md-3">
            <label>Factura / Boleta</label>
            <select class="form-select" name="infoFactura" id="facturaSeleccionada" >
            </select>
        </div>
        <div class="col-md-3">
            <label>Guia</label>
            <input class="form-control" name="infoGuia" id="guiaSeleccionada">
        </div>
    </div>
    <br>
    <div>
        <button type="button" class="btn btn-secondary"><a type="button" href="{% url 'sistema_2:dashboard' %}" style="color: white; text-decoration: none;">Salir</a></button>
        <button type="submit" class="btn btn-primary">Guardar</button>
    </div>
</form>

{% endblock %}